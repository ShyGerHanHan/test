# .github/workflows/csv-automation.yml
name: CSV ä¸‹è¼‰èˆ‡ API å‚³é€è‡ªå‹•åŒ–

# è§¸ç™¼æ¢ä»¶
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©æ—©ä¸Š10é» (å°ç£æ™‚é–“ï¼ŒUTC+8)
    - cron: '0 14 * * *' # æ¯å¤©æ™šä¸Š10é» (å°ç£æ™‚é–“)
  workflow_dispatch:  # å…è¨±æ‰‹å‹•åŸ·è¡Œ
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨é™¤éŒ¯æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

# ç’°å¢ƒè®Šæ•¸
env:
  WEBSITE_USERNAME: ${{ secrets.WEBSITE_USERNAME }}
  WEBSITE_PASSWORD: ${{ secrets.WEBSITE_PASSWORD }}
  API_KEY: ${{ secrets.API_KEY }}

jobs:
  csv-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ä¸‹è¼‰ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£å¥—ä»¶
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”§ è¨­å®š Chrome ç€è¦½å™¨
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
        
    - name: ğŸ“Š åŸ·è¡Œ CSV è‡ªå‹•åŒ–ç¨‹å¼
      run: |
        echo "é–‹å§‹åŸ·è¡Œè‡ªå‹•åŒ–ç¨‹å¼..."
        python main.py
        
    - name: ğŸ“„ ä¸Šå‚³åŸ·è¡Œæ—¥èªŒ (å¦‚æœå¤±æ•—)
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: error-logs
        path: |
          *.log
          /tmp/downloads/
        retention-days: 7
        
    - name: ğŸ“§ ç™¼é€é€šçŸ¥ (å¯é¸)
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… è‡ªå‹•åŒ–åŸ·è¡ŒæˆåŠŸ"
          # å¯ä»¥åœ¨é€™è£¡æ·»åŠ æˆåŠŸé€šçŸ¥é‚è¼¯
        else
          echo "âŒ è‡ªå‹•åŒ–åŸ·è¡Œå¤±æ•—"
          # å¯ä»¥åœ¨é€™è£¡æ·»åŠ å¤±æ•—é€šçŸ¥é‚è¼¯
        fi

  # å¯é¸ï¼šå¥åº·æª¢æŸ¥å·¥ä½œ
  health-check:
    runs-on: ubuntu-latest
    needs: csv-automation
    if: always()
    
    steps:
    - name: ğŸ“Š æª¢æŸ¥åŸ·è¡Œç‹€æ…‹
      run: |
        echo "å‰ä¸€å€‹å·¥ä½œç‹€æ…‹: ${{ needs.csv-automation.result }}"
        if [ "${{ needs.csv-automation.result }}" != "success" ]; then
          echo "âš ï¸ CSV è‡ªå‹•åŒ–åŸ·è¡Œç•°å¸¸ï¼Œéœ€è¦æª¢æŸ¥"
          exit 1
        fi
